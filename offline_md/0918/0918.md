#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
从 MySQL 数据库 realtime_v1 读取表结构
生成 Hive DDL 和 SeaTunnel 数据同步配置文件
"""

import re
import pymysql
from pathlib import Path
from datetime import datetime

# ========== 环境配置 ==========
MYSQL_HOST = "192.168.200.32"
MYSQL_PORT = 3306
MYSQL_DB   = "realtime_v1"
MYSQL_USER = "root"
MYSQL_PASS = "root"

HIVE_DB = "gmall"
HDFS_BASE = "/warehouse/gmall/ods"   # Hive 外部表存储路径

# 输出目录
OUTPUT_HIVE_DIR = Path("./output_hive_ddl")
OUTPUT_CONF_DIR = Path("./output_seatunnel_conf")

# Hive Metastore
HIVE_METASTORE = "thrift://192.168.200.32:9083"

# ===== 工具函数 =====
def mysql_to_hive_type(mysql_type: str) -> str:
"""MySQL -> Hive 类型映射"""
t = mysql_type.lower()
t_base = re.sub(r'\(.+\)', '', t).strip()
if any(x in t_base for x in ("tinyint", "smallint", "mediumint", "int")):
return "INT"
if "bigint" in t_base:
return "BIGINT"
if any(x in t_base for x in ("decimal", "numeric", "double", "float", "real")):
return "DOUBLE"
if any(x in t_base for x in ("char", "varchar", "text", "enum", "set", "json", "binary")):
return "STRING"
if any(x in t_base for x in ("date", "time", "year", "datetime", "timestamp")):
return "STRING"
return "STRING"

def safe_name(name: str) -> str:
"""字段/表名安全处理"""
return re.sub(r'\s+', '_', name.strip().lower())

# ===== 生成 Hive 建表 SQL =====
def generate_hive_create(table_name: str, columns: list, hdfs_base: str) -> str:
hive_table = f"ods_{safe_name(table_name)}"
col_lines = []
for col_name, col_type, col_comment in columns:
hive_type = mysql_to_hive_type(col_type)
comment = (col_comment or "").replace("'", "''")
col_lines.append(f"    `{safe_name(col_name)}` {hive_type} COMMENT '{comment}'")
cols_block = ",\n".join(col_lines)
location = f"{hdfs_base.rstrip('/')}/{hive_table}/"
sql = f"""DROP TABLE IF EXISTS {HIVE_DB}.{hive_table};
CREATE EXTERNAL TABLE {HIVE_DB}.{hive_table}
(
{cols_block}
) COMMENT '{table_name} 表（自动生成）'
PARTITIONED BY (`dt` STRING)
LOCATION '{location}';
"""
return sql

# ===== 生成 SeaTunnel conf =====
def generate_seatunnel_conf(table_name: str, columns: list) -> str:
hive_table = f"ods_{safe_name(table_name)}"

    # 拼接 SELECT 列清单
    select_cols = ",\n           ".join([c[0] for c in columns])
    query = f"SELECT {select_cols}, DATE_FORMAT(NOW(), '%Y%m%d') AS dt FROM {table_name}"

    conf = f"""env {{
execution.parallelism = 1
job.mode = "BATCH"
}}

source {{
jdbc {{
url = "jdbc:mysql://{MYSQL_HOST}:{MYSQL_PORT}/{MYSQL_DB}"
driver = "com.mysql.cj.jdbc.Driver"
user = "{MYSQL_USER}"
password = "{MYSQL_PASS}"
query = "{query}"
result_table_name = "{table_name}_src"
}}
}}

sink {{
hive {{
metastore_uris = "{HIVE_METASTORE}"
database = "{HIVE_DB}"
table = "{hive_table}"
source_table_name = "{table_name}_src"
save_mode = "overwrite"
partition_by = ["dt"]
}}
}}
"""
return conf

# ===== 主流程 =====
def main():
OUTPUT_HIVE_DIR.mkdir(parents=True, exist_ok=True)
OUTPUT_CONF_DIR.mkdir(parents=True, exist_ok=True)

    conn = pymysql.connect(host=MYSQL_HOST, port=MYSQL_PORT, user=MYSQL_USER,
                           password=MYSQL_PASS, database=MYSQL_DB, charset="utf8mb4")
    cursor = conn.cursor()
    cursor.execute("SHOW TABLES")
    tables = [r[0] for r in cursor.fetchall()]
    print(f"[{datetime.now()}] 发现 {len(tables)} 张表，开始生成 Hive DDL 和 SeaTunnel 配置 ...")

    for tbl in tables:
        cursor.execute(f"SHOW FULL COLUMNS FROM `{tbl}`")
        cols = []
        for row in cursor.fetchall():
            field = row[0]
            typ = row[1]
            comment = row[8] if len(row) > 8 else ""
            cols.append((field, typ, comment or ""))

        # 生成 Hive DDL
        hive_sql = generate_hive_create(tbl, cols, HDFS_BASE)
        sql_file = OUTPUT_HIVE_DIR / f"create_{safe_name(tbl)}.sql"
        sql_file.write_text(hive_sql, encoding="utf-8")

        # 生成 SeaTunnel conf
        conf_str = generate_seatunnel_conf(tbl, cols)
        conf_file = OUTPUT_CONF_DIR / f"job_{safe_name(tbl)}.conf"
        conf_file.write_text(conf_str, encoding="utf-8")

        print(f"  -> {tbl}: Hive SQL -> {sql_file.name}, SeaTunnel conf -> {conf_file.name}")

    cursor.close()
    conn.close()
    print(f"[{datetime.now()}] 全部生成完成！Hive SQL 目录: {OUTPUT_HIVE_DIR.resolve()} | SeaTunnel conf 目录: {OUTPUT_CONF_DIR.resolve()}")

if __name__ == "__main__":
main()
